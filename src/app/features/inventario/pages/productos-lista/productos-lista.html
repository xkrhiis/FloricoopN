<h2 class="mb-3">Inventario de productos</h2>

<!-- Estado de carga -->
<div *ngIf="cargando" class="text-muted mb-2">
  Cargando inventario...
</div>

<!-- Mensaje de error -->
<div *ngIf="error" class="alert alert-danger mb-3">
  {{ error }}
</div>

<!-- Tabla de productos -->
<table
  *ngIf="!cargando && productos.length"
  class="table table-striped table-hover"
>
  <thead>
    <tr>
      <th>Producto</th>
      <th>Lote</th>
      <th>Precio unitario</th>
      <th>Color</th>
      <th>Fecha ingreso</th>
      <th>Fecha límite</th>
      <th>Stock</th>
      <th>Precio total</th>
      <!-- Columna de acciones solo visible para ADMIN -->
      <th *ngIf="isAdmin" style="width: 120px;">Acciones</th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let p of productos">
      <!-- Producto -->
      <td>{{ p.nombre }}</td>

      <!-- Lote -->
      <td>{{ p.lote || '—' }}</td>

      <!-- Precio unitario -->
      <td>
        {{ p.precio | currency:'CLP':'symbol-narrow':'1.0-0' }}
      </td>

      <!-- Color -->
      <td>{{ p.color || '—' }}</td>

      <!-- Fecha ingreso -->
      <td>
        {{ p.fecha_ingreso ? (p.fecha_ingreso | date:'dd/MM/yyyy') : '—' }}
      </td>

      <!-- Fecha límite -->
      <td>
        {{ p.fecha_limite ? (p.fecha_limite | date:'dd/MM/yyyy') : '—' }}
      </td>

      <!-- Stock -->
      <td>{{ p.stock ?? 0 }}</td>

      <!-- Precio total = precio * stock (o el calculado que viene de la API) -->
      <td>
        {{
          (p.precio_total || (p.precio * (p.stock || 0)))
            | currency:'CLP':'symbol-narrow':'1.0-0'
        }}
      </td>

      <!-- Botón eliminar solo para ADMIN -->
      <td *ngIf="isAdmin">
        <button
          type="button"
          class="btn btn-sm btn-outline-danger"
          (click)="eliminarProducto(p)"
        >
          Eliminar
        </button>
      </td>
    </tr>
  </tbody>
</table>

<!-- Sin productos -->
<div *ngIf="!cargando && !productos.length">
  No hay productos en el inventario.
</div>

<hr />

<!-- Formulario de alta SOLO para ADMIN -->
<h3 *ngIf="isAdmin">Agregar nuevo producto</h3>

<form
  *ngIf="isAdmin"
  (ngSubmit)="guardarNuevo()"
  class="form-nuevo d-flex flex-wrap gap-2 align-items-end"
>
  <label class="mr-3 mb-2">
    Nombre:
    <input
      class="form-control"
      [(ngModel)]="nuevo.nombre"
      name="nombre"
      required
    />
  </label>

  <label class="mr-3 mb-2">
    Lote:
    <input
      class="form-control"
      [(ngModel)]="nuevo.lote"
      name="lote"
    />
  </label>

  <label class="mr-3 mb-2">
    Color:
    <input
      class="form-control"
      [(ngModel)]="nuevo.color"
      name="color"
    />
  </label>

  <label class="mr-3 mb-2">
    Precio:
    <input
      type="number"
      class="form-control"
      [(ngModel)]="nuevo.precio"
      name="precio"
      min="0"
      required
    />
  </label>

  <label class="mr-3 mb-2">
    Stock:
    <input
      type="number"
      class="form-control"
      [(ngModel)]="nuevo.stock"
      name="stock"
      min="0"
    />
  </label>

  <label class="mr-3 mb-2">
    Fecha ingreso:
    <input
      type="date"
      class="form-control"
      [(ngModel)]="nuevo.fecha_ingreso"
      name="fecha_ingreso"
    />
  </label>

  <label class="mr-3 mb-2">
    Fecha límite:
    <input
      type="date"
      class="form-control"
      [(ngModel)]="nuevo.fecha_limite"
      name="fecha_limite"
    />
  </label>

  <label class="mr-3 mb-2 d-flex align-items-center">
    Activo:
    <input
      type="checkbox"
      class="ml-2"
      [(ngModel)]="nuevo.activo"
      name="activo"
    />
  </label>

  <button type="submit" class="btn btn-primary mb-2">
    Guardar
  </button>
</form>
